/*
	APNG Parser ver 0.6.1 alpha
	Copyright (c) 2017 Epistemex.com
	License: CC BY-NC-SA 4.0
*/
"use strict";var APNG=APNG||{};APNG.Parser=function(d,b,h){var f=this,j,c,g={type:"image/png"};b=b.bind(f);this.width=this.height=this.iterations=this.duration=0;this.frames=[];this.frameInfo=[];this.isAPNG=!1;if(d instanceof Blob||d instanceof File){c=new FileReader();c.onloadend=function(){i(d)};c.readAsArrayBuffer(d)}else{if(typeof d==="string"){fetch(d).then(function(k){return k.arrayBuffer()}).then(i)}else{if(ArrayBuffer.isView(d)){i(d.buffer)}else{if(d instanceof ArrayBuffer){i(d)}else{throw"Unknown input type"}}}}function i(k){var D=new DataView(k),A=0,s=0,m=[];if(v()!==2303741511||v()!==218765834){throw"Not a (A)PNG file."}f.width=D.getUint32(16);f.height=D.getUint32(20);while(A<k.byteLength){var l={size:v(),name:t(),pos:A};m.push(l);if(l.name==="acTL"){f.isAPNG=!0}A+=l.size+4}if(f.isAPNG){var z=null,p=0,B=0,C,o=!1,q=!1,n=0,r=[],x=[],y=["IHDR","PLTE","gAMA","pHYs","tRNS","iCCP","sRGB","sBIT","sPLT"];m.forEach(function(E){if(y.indexOf(E.name)>-1){x.push(E)}else{if(E.name==="acTL"){A=E.pos;s=v();f.iterations=v()}else{if(E.name==="fcTL"){p++;if(z){r.push(z)}z=[];q=!0;A=E.pos;C=v();if(C>=B){B=C}else{o=!0}f.frameInfo.push({width:v(),height:v(),x:v(),y:v(),delay:u()/(u()||1)*1000,dispose:w(),blend:w()});if(D.getUint16(A-4)===0){f.frameInfo[f.frameInfo.length-1].delay=10}n+=f.frameInfo[f.frameInfo.length-1].delay}else{if(E.name==="IDAT"){if(q){z.push(new Uint8Array(D.buffer,E.pos,E.size))}}else{if(E.name==="fdAT"){C=D.getUint32(E.pos);if(C>=B){B=C}else{o=!0}z.push(new Uint8Array(D.buffer,E.pos+4,E.size-4))}}}}}});if(z){r.push(z)}f.duration=n;if(p!==s||o){console.log("Warning: APNG has sequence out of order or mismatching frame count.")}j=a();r.forEach(function(G,I){var K=[new Uint32Array([1196314761,169478669])],J=f.frameInfo[I],E,M,H;if(m[0].name!=="IHDR"){throw"Error in PNG. IHDR not in correct position."}x.forEach(function(N){var O,P;if(N.name==="IHDR"){O=new DataView(D.buffer,N.pos,N.size);O.setUint32(0,J.width);O.setUint32(4,J.height);P=e("IHDR",new Uint8Array(D.buffer,N.pos,N.size));K.push(P)}else{K.push(new Uint8Array(D.buffer,N.pos-8,N.size+12))}});G.forEach(function(N){K.push(e("IDAT",N))});K.push(new Uint32Array([0,1145980233,2187346606]));E=new Blob(K,g);K=null;M=URL.createObjectURL(E);H=new Image;H.onload=L;H.onerror=F;H.src=M;f.frames.push(H);function L(){URL.revokeObjectURL(this.src);if(I===s-1){b()}}function F(){if(h){h("Internal error producing PNG.")}else{if(I===s-1){b()}}}})}else{f.frames.push(new Image);f.frames[0].onload=function(){URL.revokeObjectURL(this.src);f.frameInfo.push({x:0,y:0,width:f.width,height:f.height,delay:-1,dispose:1,blend:0});b()};f.frames[0].src=URL.createObjectURL(new Blob([k],g))}function w(){return D.getUint8(A++)}function u(){var E=D.getUint16(A);A+=2;return E}function v(){var E=D.getUint32(A);A+=4;return E}function t(){var F=v(),E=String.fromCharCode;return E(F>>>24)+E(F>>16&255)+E(F>>8&255)+E(F&255)}}function a(){var n=new Uint32Array(256),l=0,m,k;while(l<256){k=l>>>0;for(m=0;m<8;m++){k=(k&1)?3988292384^(k>>>1):k>>>1}n[l++]=k}return n}function e(p,m){var l=new Uint8Array(m.length+12),n=new DataView(l.buffer);n.setUint32(0,m.length);n.setUint32(4,o(p));l.set(m,8);n.setUint32(l.length-4,k(l));function o(r){var q=r.charCodeAt.bind(r);return q(0)<<24|(q(1)&255)<<16|(q(2)&255)<<8|q(3)&255}function k(q){var r=(-1>>>0),t=q.length-4,s=4;while(s<t){r=(r>>>8)^j[(r^q[s++])&255]}return r^-1}return l}};