/*
	APNG Parser ver 0.2.0 alpha
	Copyright (c) 2017 Epistemex
	www.epistemex.com
	License: CC BY-NC-SA 4.0
*/
"use strict";function APNGParser(d,b,h){var f=this,j,c,g={type:"image/png"};b=b.bind(f);this.width=0;this.height=0;this.iterations=0;this.frames=[];this.frameInfo=[];this.isAPNG=!1;if(d instanceof Blob||d instanceof File){c=new FileReader();c.onloadend=function(){i(d)};c.readAsArrayBuffer(d)}else{if(typeof d==="string"){fetch(d).then(function(k){return k.arrayBuffer()}).then(i)}else{if(ArrayBuffer.isView(d)){i(d.buffer)}else{if(d instanceof ArrayBuffer){i(d)}else{throw"Wrong input type"}}}}function i(k){var z=new DataView(k),y=0,p=0,m=[],w=!1;if(s()!==2303741511||s()!==218765834){throw"Not a (A)PNG file."}f.width=z.getUint32(16);f.height=z.getUint32(20);while(y<k.byteLength){var l={size:s(),name:q(),pos:y};m.push(l);if(l.name==="acTL"){w=!0}y+=l.size+4}if(w){f.isAPNG=!0;var x=null,n=!1,o=[],u=[],v=["IHDR","PLTE","gAMA","pHYs","tRNS","iCCP","sRGB","sBIT","sPLT"];m.forEach(function(A){if(v.indexOf(A.name)>-1){u.push(A)}else{if(A.name==="acTL"){y=A.pos;p=s();f.iterations=s()}else{if(A.name==="fcTL"){if(x){o.push(x)}x=[];n=!0;y=A.pos+4;f.frameInfo.push({width:s(),height:s(),x:s(),y:s(),delay:r()/(r()||1)*1000,dispose:t(),blend:t()});if(z.getUint16(y-4)===0){f.frameInfo[f.frameInfo.length-1].delay=10}}else{if(A.name==="IDAT"){if(n){x.push(new Uint8Array(z.buffer,A.pos,A.size))}}else{if(A.name==="fdAT"){x.push(new Uint8Array(z.buffer,A.pos+4,A.size-4))}}}}}});if(x){o.push(x)}if(f.frameInfo[0].dispose===2){f.frameInfo[0].dispose=1}j=a();o.forEach(function(C,E){var G=[new Uint32Array([1196314761,169478669])],F=f.frameInfo[E],A,I,D;if(m[0].name!=="IHDR"){throw"Error in PNG. IHDR not in correct position."}u.forEach(function(J){var K,L;if(J.name==="IHDR"){K=new DataView(z.buffer,J.pos,J.size);K.setUint32(0,F.width);K.setUint32(4,F.height);L=e("IHDR",new Uint8Array(z.buffer,J.pos,J.size));G.push(L)}else{G.push(new Uint8Array(z.buffer,J.pos-8,J.size+12))}});C.forEach(function(J){G.push(e("IDAT",J))});G.push(new Uint32Array([0,1145980233,2187346606]));A=new Blob(G,g);G=null;I=URL.createObjectURL(A);D=new Image;D.onload=H;D.onerror=B;D.src=I;f.frames.push(D);function H(){URL.revokeObjectURL(this.src);if(E===p-1){b()}}function B(){if(h){h("Internal error producing PNG.")}else{if(E===p-1){b()}}}})}else{f.frames.push(new Image);f.frames[0].onload=function(){URL.revokeObjectURL(this.src);f.frameInfo.push({x:0,y:0,width:f.width,height:f.height,delay:-1,dispose:1,blend:0});b()};f.frames[0].src=URL.createObjectURL(new Blob([k],g))}function t(){return z.getUint8(y++)}function r(){var A=z.getUint16(y);y+=2;return A}function s(){var A=z.getUint32(y);y+=4;return A}function q(){var B=s(),A=String.fromCharCode;return A(B>>>24)+A(B>>16&255)+A(B>>8&255)+A(B&255)}}function a(){var n=new Uint32Array(256),l=0,m,k;while(l<256){k=l>>>0;for(m=0;m<8;m++){k=(k&1)?3988292384^(k>>>1):k>>>1}n[l++]=k}return n}function e(p,m){var l=new Uint8Array(m.length+12),n=new DataView(l.buffer);n.setUint32(0,m.length);n.setUint32(4,o(p));l.set(m,8);n.setUint32(l.length-4,k(l));function o(r){var q=r.charCodeAt.bind(r);return q(0)<<24|(q(1)&255)<<16|(q(2)&255)<<8|q(3)&255}function k(q){var r=(-1>>>0),t=q.length-4,s=4;while(s<t){r=(r>>>8)^j[(r^q[s++])&255]}return r^-1}return l}};