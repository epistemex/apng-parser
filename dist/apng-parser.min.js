/*
	APNG Parser ver 0.4.0 alpha
	Copyright (c) 2017 Epistemex.com
	License: CC BY-NC-SA 4.0
*/
"use strict";var APNG=APNG||{};APNG.Parser=function(d,b,h){var f=this,j,c,g={type:"image/png"};b=b.bind(f);this.width=this.height=this.iterations=0;this.frames=[];this.frameInfo=[];this.isAPNG=!1;if(d instanceof Blob||d instanceof File){c=new FileReader();c.onloadend=function(){i(d)};c.readAsArrayBuffer(d)}else{if(typeof d==="string"){fetch(d).then(function(k){return k.arrayBuffer()}).then(i)}else{if(ArrayBuffer.isView(d)){i(d.buffer)}else{if(d instanceof ArrayBuffer){i(d)}else{throw"Unknown input type"}}}}function i(k){var y=new DataView(k),x=0,p=0,m=[];if(s()!==2303741511||s()!==218765834){throw"Not a (A)PNG file."}f.width=y.getUint32(16);f.height=y.getUint32(20);while(x<k.byteLength){var l={size:s(),name:q(),pos:x};m.push(l);if(l.name==="acTL"){f.isAPNG=!0}x+=l.size+4}if(f.isAPNG){var w=null,n=!1,o=[],u=[],v=["IHDR","PLTE","gAMA","pHYs","tRNS","iCCP","sRGB","sBIT","sPLT"];m.forEach(function(z){if(v.indexOf(z.name)>-1){u.push(z)}else{if(z.name==="acTL"){x=z.pos;p=s();f.iterations=s()}else{if(z.name==="fcTL"){if(w){o.push(w)}w=[];n=!0;x=z.pos+4;f.frameInfo.push({width:s(),height:s(),x:s(),y:s(),delay:r()/(r()||1)*1000,dispose:t(),blend:t()});if(y.getUint16(x-4)===0){f.frameInfo[f.frameInfo.length-1].delay=10}}else{if(z.name==="IDAT"){if(n){w.push(new Uint8Array(y.buffer,z.pos,z.size))}}else{if(z.name==="fdAT"){w.push(new Uint8Array(y.buffer,z.pos+4,z.size-4))}}}}}});if(w){o.push(w)}if(f.frameInfo[0].dispose===2){f.frameInfo[0].dispose=1}j=a();o.forEach(function(B,D){var F=[new Uint32Array([1196314761,169478669])],E=f.frameInfo[D],z,H,C;if(m[0].name!=="IHDR"){throw"Error in PNG. IHDR not in correct position."}u.forEach(function(I){var J,K;if(I.name==="IHDR"){J=new DataView(y.buffer,I.pos,I.size);J.setUint32(0,E.width);J.setUint32(4,E.height);K=e("IHDR",new Uint8Array(y.buffer,I.pos,I.size));F.push(K)}else{F.push(new Uint8Array(y.buffer,I.pos-8,I.size+12))}});B.forEach(function(I){F.push(e("IDAT",I))});F.push(new Uint32Array([0,1145980233,2187346606]));z=new Blob(F,g);F=null;H=URL.createObjectURL(z);C=new Image;C.onload=G;C.onerror=A;C.src=H;f.frames.push(C);function G(){URL.revokeObjectURL(this.src);if(D===p-1){b()}}function A(){if(h){h("Internal error producing PNG.")}else{if(D===p-1){b()}}}})}else{f.frames.push(new Image);f.frames[0].onload=function(){URL.revokeObjectURL(this.src);f.frameInfo.push({x:0,y:0,width:f.width,height:f.height,delay:-1,dispose:1,blend:0});b()};f.frames[0].src=URL.createObjectURL(new Blob([k],g))}function t(){return y.getUint8(x++)}function r(){var z=y.getUint16(x);x+=2;return z}function s(){var z=y.getUint32(x);x+=4;return z}function q(){var A=s(),z=String.fromCharCode;return z(A>>>24)+z(A>>16&255)+z(A>>8&255)+z(A&255)}}function a(){var n=new Uint32Array(256),l=0,m,k;while(l<256){k=l>>>0;for(m=0;m<8;m++){k=(k&1)?3988292384^(k>>>1):k>>>1}n[l++]=k}return n}function e(p,m){var l=new Uint8Array(m.length+12),n=new DataView(l.buffer);n.setUint32(0,m.length);n.setUint32(4,o(p));l.set(m,8);n.setUint32(l.length-4,k(l));function o(r){var q=r.charCodeAt.bind(r);return q(0)<<24|(q(1)&255)<<16|(q(2)&255)<<8|q(3)&255}function k(q){var r=(-1>>>0),t=q.length-4,s=4;while(s<t){r=(r>>>8)^j[(r^q[s++])&255]}return r^-1}return l}};