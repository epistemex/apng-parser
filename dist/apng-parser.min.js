/*
	APNG Parser ver 0.1.1 alpha
	Copyright (c) 2017 Epistemex
	www.epistemex.com
	License: CC BY-NC-SA 4.0
*/
"use strict";function APNGParser(d,b,g){var f=this,i,c;if(b){b=b.bind(f)}else{b=function(){console.log("No callback provided.")}}this.width=0;this.height=0;this.iterations=0;this.frames=[];this.frameInfo=[];if(d instanceof Blob||d instanceof File){c=new FileReader();c.onloadend=function(){h(d)};c.readAsArrayBuffer(d)}else{if(typeof d==="string"){fetch(d).then(function(j){return j.arrayBuffer()}).then(h)}else{if(ArrayBuffer.isView(d)){h(d.buffer)}else{if(d instanceof ArrayBuffer){h(d)}else{throw"Wrong input type"}}}}function h(j){var z=new DataView(j),y=0,p=0,l=[],w=!1;if(s()!==2303741511||s()!==218765834){throw"Not a (A)PNG file."}f.width=z.getUint32(16);f.height=z.getUint32(20);while(y<j.byteLength){var k={size:s(),name:q(),pos:y};l.push(k);if(k.name==="acTL"){w=!0}y+=k.size+4}if(w){var x=null,o=!1,n=[],u=[],v=["IHDR","PLTE","gAMA","pHYs","tRNS","iCCP","sRGB","sBIT","sPLT"],m;l.forEach(function(A){if(v.indexOf(A.name)>-1){u.push(A)}else{if(A.name==="acTL"){y=A.pos;p=s();f.iterations=s()}else{if(A.name==="fcTL"){if(x){n.push(x)}x=[];o=!0;y=A.pos+4;f.frameInfo.push({width:s(),height:s(),x:s(),y:s(),delay:r()/(r()||1)*1000,dispose:t(),blend:t()});if(z.getUint16(y-4)===0){f.frameInfo[f.frameInfo.length-1].delay=10}}else{if(A.name==="IDAT"){if(o){m=new Uint8Array(z.buffer,A.pos,A.size);x.push(m)}}else{if(A.name==="fdAT"){m=new Uint8Array(z.buffer,A.pos+4,A.size-4);x.push(m)}}}}}});if(x){n.push(x)}if(f.frameInfo[0].dispose===2){f.frameInfo[0].dispose=1}i=a();n.forEach(function(B,D){var F=[new Uint32Array([1196314761,169478669])],E=f.frameInfo[D],A,G,C;if(l[0].name!=="IHDR"){throw"Error in PNG. IHDR not in correct position."}u.forEach(function(H){if(H.name==="IHDR"){var I=new Uint8Array(z.buffer,H.pos,H.size);var J=new DataView(z.buffer,H.pos,H.size);J.setUint32(0,E.width);J.setUint32(4,E.height);var K=e("IHDR",I);F.push(K)}else{F.push(new Uint8Array(z.buffer,H.pos-8,H.size+12))}});B.forEach(function(H){F.push(e("IDAT",H))});F.push(new Uint8Array([0,0,0,0,73,69,78,68,174,66,96,130]));A=new Blob(F,{type:"image/png"});G=URL.createObjectURL(A);C=new Image;C.onload=function(){URL.revokeObjectURL(this.src);if(D===p-1){b()}};C.onerror=function(){console.log("Error creating PNG from frame.");if(g){g("Internal error loading produced PNG")}else{if(D===p-1){b()}}};C.src=G;f.frames.push(C)})}else{f.frames.push(new Image);f.frames[0].onload=function(){URL.revokeObjectURL(this.src);f.frameInfo.push({x:0,y:0,width:f.width,height:f.height,delay:-1,dispose:1,blend:0});b()};f.frames[0].src=URL.createObjectURL(new Blob([j],{type:"image/png"}))}function t(){return z.getUint8(y++)}function r(){var A=z.getUint16(y);y+=2;return A}function s(){var A=z.getUint32(y);y+=4;return A}function q(){var B=s(),A=String.fromCharCode;return A(B>>>24)+A(B>>16&255)+A(B>>8&255)+A(B&255)}}function a(){var n=new Uint32Array(256),l=0,m,k;while(l<256){k=l>>>0;for(m=0;m<8;m++){k=(k&1)?3988292384^(k>>>1):k>>>1}n[l++]=k}return n}function e(o,l){var k=new Uint8Array(l.length+12),m=new DataView(k.buffer);m.setUint32(0,l.length);m.setUint32(4,n(o));k.set(l,8);m.setUint32(k.length-4,j(k));function n(q){var p=q.charCodeAt.bind(q);return p(0)<<24|(p(1)&255)<<16|(p(2)&255)<<8|p(3)&255}function j(p){var q=(-1>>>0),s=p.length-4,r=4;while(r<s){q=(q>>>8)^i[(q^p[r++])&255]}return q^-1}return k}};