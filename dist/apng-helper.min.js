"use strict";APNG=APNG||{};APNG.Helper=function(b,a,p){p=Object.assign({iterations:-1,ignoreIterations:!0,forceRequestAnimationFrame:!1,mode:"forward",debug:!1,debugColorRegion:"#f0f",debugColorText:"#fff",debugTextPosition:{x:5,y:12},debugTextFont:null},p);var o=this,t=document.createElement("canvas"),g=t.getContext("2d"),f=b.getContext("2d"),s=-1,h=0,k,j,c=0,n=0,m,d=!1,e=!0,u;this.context=f;this.playing=!1;this.onplay=this.onstop=this.onpause=this.onended=this.onframe=this.oniteration=null;i("mode",function(){return p.mode},function(v){k=a.frames.concat();j=a.frameInfo.concat();if(v==="backward"){k.reverse();j.reverse()}else{if(v==="pingpong"){k=k.concat(k.concat().reverse());j=j.concat(j.concat().reverse())}}if(c>=k.length){c=0}p.mode=v});i("currentFrame",function(){return c},function(v){var w=0;if(v<0){v=0}else{if(v>=k.length){v=k.length-1}}f.canvas.width=b.width;c=0;while(w++<=v){r();c++}if(o.onframe){o.onframe(l())}});i("currentTime",function(){return o.playing?performance.now()-s:h-s},function(x){var w=0,v=0;while(w<j.length){v+=j[w].delay;if(v>=x){o.currentFrame=w;if(o.onframe){o.onframe(l())}return}w++}});i("duration",function(){return a.duration});i("commit",function(){return e},function(w){var v=e;e=!!w;if(!v&&e){o.currentFrame=c}});i("debug",function(){return p.debug},function(v){p.debug=!!v});i("debugColorText",function(){return f.fillStyle},function(v){f.fillStyle=v});i("debugColorRegion",function(){return f.strokeStyle},function(v){f.strokeStyle=v});i("debugTextPosition",function(){return p.debugTextPosition},function(v){p.debugTextPosition=v});i("debugTextFont",function(){return f.font},function(v){f.font=v});i("canvas",function(){return b},function(v){b=v;o.context=f=b.getContext("2d");if(!f){throw"This canvas cannot be used for 2D."}b.width=a.width;b.height=a.height;if(p.debugTextFont){f.font=p.debugTextFont}f.fillStyle=p.debugColorText;f.strokeStyle=p.debugColorRegion});this.play=function(){if(!o.playing){q()}};this.stop=function(){if(!o.playing){return}o.pause();c=0;s=-1;r();if(o.onstop){o.onstop(l())}};this.pause=function(){if(!o.playing){return}o.playing=!1;clearTimeout(u);cancelAnimationFrame(u);if(o.onpause){o.onpause(l())}};function q(){var x=performance.now.bind(performance);o.playing=!0;function w(){var y=j[c];if(e){r();if(o.onframe){o.onframe(l())}}u=(y.delay>=16&&y.delay<=17)||p.forceRequestAnimationFrame?requestAnimationFrame(v):setTimeout(v,y.delay)}function v(){if(++c>=k.length){c=0;s=x();n++;if(o.oniteration){o.oniteration(l())}if(n>=m&&!p.ignoreIterations){o.playing=!1;if(o.onended){o.onended(l())}}}h=x();if(o.playing){w()}}s=x();w();if(o.onplay){o.onplay(l())}}function r(){var v=k[c],w=j[c];if(d){f.drawImage(t,0,0);d=!1}if(w.dispose===1){f.clearRect(w.x|0,w.y|0,w.width|0,w.height|0)}else{if(w.dispose===2){g.clearRect(0,0,t.width|0,t.height|0);g.drawImage(b,w.x|0,w.y|0,w.width|0,w.height|0,w.x|0,w.y|0,w.width|0,w.height|0);d=!0}}if(w.blend===0){f.clearRect(w.x|0,w.y|0,w.width|0,w.height|0)}f.drawImage(v,w.x|0,w.y|0);if(p.debug){f.strokeRect((w.x|0)+0.5,(w.y|0)+0.5,(w.width-1)|0,(w.height-1)|0);f.fillText("F:"+c+"  D:"+w.dispose+"  B:"+w.blend,p.debugTextPosition.x,p.debugTextPosition.y)}}function l(){return{timeStamp:Date.now(),context:f,target:o}}function i(x,w,y){var v={get:w};if(y){v.set=y}Object.defineProperty(o,x,v)}b.width=t.width=a.width;b.height=t.height=a.height;m=p.iterations<0?a.iterations:p.iterations;if(!m){p.ignoreIterations=!0}else{if(m<0){p.ignoreIterations=!!(m=0)}}f.fillStyle=p.debugColorText;f.strokeStyle=p.debugColorRegion;if(p.debugTextFont){f.font=p.debugTextFont}o.mode=p.mode};APNG.Helper.toSpritesheet=function(b,h){h=Object.assign({maxWidth:6000,drawCallback:null},h);var c=document.createElement("canvas"),d=document.createElement("canvas"),f=d.getContext("2d"),a=new APNG.Helper(c,b),e;if(h.drawCallback){a.onframe=h.drawCallback}if(b.width*b.frames.length>h.maxWidth){e=Math.floor(h.maxWidth/b.width);d.width=e*b.width;d.height=Math.ceil((b.width*(b.frames.length))/h.maxWidth)*b.height}else{d.width=b.width*b.frames.length;d.height=b.height}for(var g=0,j=0,k=0;g<b.frames.length;g++){a.currentFrame=g;f.drawImage(c,j,k);j+=b.width;if(j>=h.maxWidth){j=0;k+=b.height}}return f.canvas};APNG.Helper.retime=function(a,b){this._cd(function(c){c.delay*=b})};APNG.Helper.setDuration=function(a,b){var c=b/a.duration;this._cd(function(d){d.delay*=c})};APNG.Helper.setDelay=function(a,b){this._cd(function(c){c.delay=b})};APNG.Helper._cd=function(b){var a=apng.frameInfo;a.forEach(b);apng.duration=a.reduce(function(d,c){return d+c.delay},0)};