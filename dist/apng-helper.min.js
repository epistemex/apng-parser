"use strict";APNG=APNG||{};APNG.Helper=function(b,a,p){p=Object.assign({iterations:-1,ignoreIterations:!0,forceRequestAnimationFrame:!1,mode:"forward",debug:!1,debugColorRegion:"#f0f",debugColorText:"#fff",debugTextPosition:{x:5,y:12}},p);var o=this,s=document.createElement("canvas"),g=s.getContext("2d"),f=b.getContext("2d"),r=-1,h=0,k,j,c=0,n=0,m,d=!1,e=!0,t;this.context=f;this.playing=!1;this.onplay=this.onstop=this.onpause=this.onend=this.onframe=this.oniteration=null;i("mode",function(){return p.mode},function(u){k=a.frames.concat();j=a.frameInfo.concat();if(u==="backward"){k.reverse();j.reverse()}else{if(u==="pingpong"){k=k.concat(k.concat().reverse());j=j.concat(j.concat().reverse())}}if(c>=k.length){c=0}p.mode=u});i("currentFrame",function(){return c},function(u){var v=0;if(u<0){u=0}else{if(u>=k.length){u=k.length-1}}f.canvas.width=b.width;c=0;while(v++<=u){q();c++}if(o.onframe){o.onframe(l())}});i("currentTime",function(){return o.playing?performance.now()-r:h-r},function(w){var v=0,u=0;while(v<j.length){u+=j[v].delay;if(u>=w){o.currentFrame=v;if(o.onframe){o.onframe(l())}return}v++}});i("duration",function(){return a.duration});i("commit",function(){return e},function(v){var u=e;e=!!v;if(!u&&e){o.currentFrame=c}});i("debug",function(){return p.debug},function(u){p.debug=!!u});i("debugColorText",function(){return f.fillStyle},function(u){f.fillStyle=u});i("debugColorRegion",function(){return f.strokeStyle},function(u){f.strokeStyle=u});i("debugTextPosition",function(){return p.debugTextPosition},function(u){p.debugTextPosition=u});i("canvas",function(){return b},function(u){b=u;o.context=f=b.getContext("2d");if(!f){throw"This canvas cannot be used for 2D."}b.width=a.width;b.height=a.height});this.play=function(){o.playing=!0;function v(){var w=j[c];if(e){q();if(o.onframe){o.onframe(l())}}t=(w.delay>=16&&w.delay<=17)||p.forceRequestAnimationFrame?requestAnimationFrame(u):setTimeout(u,w.delay)}function u(){if(++c>=k.length){c=0;r=performance.now();n++;if(o.oniteration){o.oniteration(l())}if(n>=m&&!p.ignoreIterations){o.playing=!1;if(o.onended){o.onended(l())}}}h=performance.now();if(o.playing){v()}}r=performance.now();v();if(o.onplay){o.onplay(l())}};this.stop=function(){o.pause();c=0;r=-1;q();if(o.onstop){o.onstop(l())}};this.pause=function(){o.playing=!1;clearTimeout(t);cancelAnimationFrame(t);if(o.onpause){o.onpause(l())}};function q(){var u=k[c],v=j[c];if(d){f.drawImage(s,0,0);d=!1}if(v.dispose===1){f.clearRect(v.x|0,v.y|0,v.width|0,v.height|0)}else{if(v.dispose===2){g.clearRect(0,0,s.width|0,s.height|0);g.drawImage(b,v.x|0,v.y|0,v.width|0,v.height|0,v.x|0,v.y|0,v.width|0,v.height|0);d=!0}}if(v.blend===0){f.clearRect(v.x|0,v.y|0,v.width|0,v.height|0)}f.drawImage(u,v.x|0,v.y|0);if(p.debug){f.strokeRect((v.x|0)+0.5,(v.y|0)+0.5,(v.width-1)|0,(v.height-1)|0);f.fillText("F:"+c+"  D:"+v.dispose+"  B:"+v.blend,p.debugTextPosition.x,p.debugTextPosition.y)}}function l(){return{timeStamp:Date.now(),context:f,target:o}}function i(w,v,x){var u={get:v};if(x){u.set=x}Object.defineProperty(o,w,u)}b.width=s.width=a.width;b.height=s.height=a.height;m=p.iterations<0?a.iterations:p.iterations;if(!m){p.ignoreIterations=!0}else{if(m<0){p.ignoreIterations=!!(m=0)}}if(p.debug){f.fillStyle=p.debugColorText;f.strokeStyle=p.debugColorRegion}o.mode=p.mode};APNG.Helper.toSpritesheet=function(b,h){h=Object.assign({maxWidth:6000,drawCallback:null},h);var c=document.createElement("canvas"),d=document.createElement("canvas"),f=d.getContext("2d"),a=new APNG.Helper(c,b),e;if(h.drawCallback){a.onframe=h.drawCallback}if(b.width*b.frames.length>h.maxWidth){e=Math.floor(h.maxWidth/b.width);d.width=e*b.width;d.height=Math.ceil((b.width*(b.frames.length))/h.maxWidth)*b.height}else{d.width=b.width*b.frames.length;d.height=b.height}for(var g=0,j=0,k=0;g<b.frames.length;g++){a.currentFrame=g;f.drawImage(c,j,k);j+=b.width;if(j>=h.maxWidth){j=0;k+=b.height}}return f.canvas};APNG.Helper.retime=function(a,b){this._fn(function(c){c.delay*=b})};APNG.Helper.setDuration=function(a,b){var c=b/a.duration;this._fn(function(d){d.delay*=c})};APNG.Helper.setDelay=function(a,b){this._fn(function(c){c.delay=b})};APNG.Helper._fn=function(b){var a=apng.frameInfo;a.forEach(b);apng.duration=a.reduce(function(d,c){return d+c.delay},0)};